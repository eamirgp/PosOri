@page "/product"

@using Pos.App.Features.Product.Components
@using Pos.App.Features.Product.Models
@using Pos.App.Services.Interfaces
@using Pos.App.Shared.Pagination

@inject IProductService ProductService

@implements IDisposable

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-box-seam text-primary me-2"></i>
                        Gestión de Productos
                    </h2>
                    <p class="text-muted mb-0">Administra tu catálogo de productos</p>
                </div>
                <button class="btn btn-primary btn-lg shadow-sm" @onclick="OpenCreateModal" disabled="@_isLoading">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nuevo Producto
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search Section -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group input-group-lg">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text"
                       class="form-control border-start-0"
                       placeholder="Buscar por código o nombre del producto..."
                       @oninput="OnSearchChanged"
                       disabled="@_isLoading" />
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="d-inline-flex align-items-center gap-2">
                <span class="text-muted">Mostrar:</span>
                <select class="form-select form-select-lg w-auto"
                        value="@_pageSize"
                        @onchange="OnPageSizeChanged"
                        disabled="@_isLoading">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                </select>
                <span class="text-muted">registros</span>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    @if (_products.Items is not null && _products.Items.Any())
    {
        <div class="row mb-3">
            <div class="col">
                <div class="alert alert-light border d-flex align-items-center mb-0" role="alert">
                    <i class="bi bi-info-circle text-primary me-2"></i>
                    <span>
                        Mostrando <strong>@_products.Items.Count</strong> de <strong>@_products.TotalCount</strong> productos
                        @if (!string.IsNullOrWhiteSpace(_searchTerm))
                        {
                            <span> - Búsqueda: "<strong>@_searchTerm</strong>"</span>
                        }
                    </span>
                </div>
            </div>
        </div>
    }

    <!-- Products Table -->
    <div class="row">
        <div class="col">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="px-4 py-3" style="width: 10%">
                                        <i class="bi bi-upc-scan me-1"></i>
                                        Código
                                    </th>
                                    <th class="py-3" style="width: 20%">
                                        <i class="bi bi-tag me-1"></i>
                                        Nombre
                                    </th>
                                    <th class="py-3" style="width: 12%">
                                        <i class="bi bi-rulers me-1"></i>
                                        U. Medida
                                    </th>
                                    <th class="py-3" style="width: 15%">
                                        <i class="bi bi-percent me-1"></i>
                                        IGV
                                    </th>
                                    <th class="py-3" style="width: 13%">
                                        <i class="bi bi-folder me-1"></i>
                                        Categoría
                                    </th>
                                    <th class="py-3 text-end" style="width: 10%">
                                        <i class="bi bi-currency-dollar me-1"></i>
                                        P. Compra
                                    </th>
                                    <th class="py-3 text-end" style="width: 10%">
                                        <i class="bi bi-tag-fill me-1"></i>
                                        P. Venta
                                    </th>
                                    <th class="py-3 text-center" style="width: 10%">
                                        <i class="bi bi-gear me-1"></i>
                                        Acciones
                                    </th>
                                </tr>
                            </thead>

                            @if (_isLoading)
                            {
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="text-muted mt-2 mb-0">Cargando productos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            }
                            else if (_products.Items is not null && _products.Items.Any())
                            {
                                <tbody>
                                    @foreach (var product in _products.Items)
                                    {
                                        <tr>
                                            <td class="px-4">
                                                <span class="badge bg-light text-dark border fs-6">@product.Code</span>
                                            </td>
                                            <td>
                                                <div class="fw-semibold">@product.Name</div>
                                                @if (!string.IsNullOrWhiteSpace(product.Description))
                                                {
                                                    <small class="text-muted">@product.Description</small>
                                                }
                                            </td>
                                            <td>@product.UnitOfMeasure</td>
                                            <td>
                                                <small>@product.IGVType</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary-subtle text-primary">@product.Category</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="fw-semibold">S/ @product.PurchasePrice.ToString("N2")</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="fw-semibold text-success">S/ @product.SalePrice.ToString("N2")</span>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button class="btn btn-outline-primary"
                                                            title="Editar"
                                                            disabled>
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger"
                                                            title="Eliminar"
                                                            disabled>
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            }
                            else
                            {
                                <tbody>
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="py-5">
                                                <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
                                                <h5 class="text-muted">No se encontraron productos</h5>
                                                <p class="text-muted mb-3">
                                                    @if (!string.IsNullOrWhiteSpace(_searchTerm))
                                                    {
                                                        <span>No hay productos que coincidan con tu búsqueda.</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Comienza agregando tu primer producto.</span>
                                                    }
                                                </p>
                                                <button class="btn btn-primary" @onclick="OpenCreateModal">
                                                    <i class="bi bi-plus-circle me-2"></i>
                                                    Crear Primer Producto
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            }
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                @if (_products.Items is not null && _products.Items.Any())
                {
                    <div class="card-footer bg-white border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted">
                                Página <strong>@_products.PageNumber</strong> de <strong>@_products.TotalPages</strong>
                            </div>

                            <nav>
                                <ul class="pagination mb-0">
                                    <li class="page-item @(!_products.HasPreviousPage || _isLoading ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(1)" @onclick:preventDefault>
                                            <i class="bi bi-chevron-double-left"></i>
                                        </a>
                                    </li>

                                    <li class="page-item @(!_products.HasPreviousPage || _isLoading ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="PreviousPage" @onclick:preventDefault>
                                            <i class="bi bi-chevron-left"></i> Anterior
                                        </a>
                                    </li>

                                    <li class="page-item @(!_products.HasNextPage || _isLoading ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="NextPage" @onclick:preventDefault>
                                            Siguiente <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>

                                    <li class="page-item @(!_products.HasNextPage || _isLoading ? "disabled" : "")">
                                        <a class="page-link" href="#" @onclick="() => GoToPage(_products.TotalPages)" @onclick:preventDefault>
                                            <i class="bi bi-chevron-double-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Component -->
<CreateProductModal @ref="_createModal" OnProductCreated="OnProductCreated" />

@code {
    private CreateProductModal _createModal = default!;
    private PaginatedResultModel<ProductListModel> _products = new(new List<ProductListModel>(), 1, 15, 0, 0, false, false);
    private int _pageNumber = 1;
    private int _pageSize = 15;
    private string? _searchTerm;
    private Timer? _debounceTimer;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _isLoading = true;

        try
        {
            _products = await ProductService.GetAllProductsAsync(_pageNumber, _pageSize, _searchTerm);
        }
        catch (Exception)
        {
            _products = new(new List<ProductListModel>(), _pageNumber, _pageSize, 0, 0, false, false);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        _searchTerm = e.Value?.ToString();

        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(async _ =>
        {
            _pageNumber = 1;
            await InvokeAsync(async () =>
            {
                await LoadProducts();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= _products.TotalPages && !_isLoading)
        {
            _pageNumber = page;
            await LoadProducts();
        }
    }

    private async Task PreviousPage()
    {
        if (_products.HasPreviousPage && !_isLoading)
        {
            _pageNumber--;
            await LoadProducts();
        }
    }

    private async Task NextPage()
    {
        if (_products.HasNextPage && !_isLoading)
        {
            _pageNumber++;
            await LoadProducts();
        }
    }

    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        if (!_isLoading)
        {
            _pageSize = int.Parse(e.Value?.ToString() ?? "15");
            _pageNumber = 1;
            await LoadProducts();
        }
    }

    private async Task OnProductCreated()
    {
        _pageNumber = 1;
        await LoadProducts();
    }

    private void OpenCreateModal()
    {
        _createModal.Open();
    }
}
