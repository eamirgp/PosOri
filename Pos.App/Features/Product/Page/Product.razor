@page "/product"

@using Pos.App.Features.Product.Components
@using Pos.App.Features.Product.Model
@using Pos.App.Services.Interfaces
@using Pos.App.Shared.Pagination

@inject IProductService ProductService

@implements IDisposable

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <button class="btn btn-primary">
            <i class="bi bi-plus"></i>
            Crear producto
        </button>
        <input type="text" class="form-control w-auto" placeholder="Buscar..." @oninput="OnSearchChanged" />
    </div>

    <div>
        <table class="table table-sm table-hover" style="table-layout: fixed;">
            <thead>
                <tr class="align-middle">
                    <th style="width: 120px">Código</th>
                    <th style="width: 250px">Nombre</th>
                    <th style="width: 120px">Unidad de medida</th>
                    <th style="width: 180px">IGV</th>
                    <th style="width: 120px">Categoría</th>
                    <th style="width: 100px">Precio de compra</th>
                    <th style="width: 100px">Precio de venta</th>
                    <th style="width: 120px">Acciones</th>
                </tr>
            </thead>

            @if (_products.Items is not null && _products.Items.Any())
            {
                <tbody>
                    @foreach (var product in _products.Items)
                    {
                        <tr class="align-middle">
                            <td>@product.Code</td>
                            <td>@product.Name</td>
                            <td>@product.UnitOfMeasure</td>
                            <td>@product.IGVType</td>
                            <td>@product.Category</td>
                            <td>@product.PurchasePrice</td>
                            <td>@product.SalePrice</td>
                            <td>
                                <button class="btn btn-primary btn-sm">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-danger btn-sm">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            }
            else
            {
                <tbody>
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            No se encontraron productos
                        </td>
                    </tr>
                </tbody>
            }
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-start">
        <div class="d-flex align-items-center gap-2">
            <label>Mostrar:</label>
            <select class="form-select form-select-sm" value="@_pageSize" @onchange="OnPageSizeChanged">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>

        <div class="d-inline-block">
            <nav>
                <ul class="pagination">
                    <li class="page-item @(!_products.HasPreviousPage ? "disabled" : "")">
                        <a class="page-link" href="#" @onclick="() => GoToPage(1)" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>

                    <li class="page-item @(!_products.HasPreviousPage ? "disabled" : "")">
                        <a class="page-link" href="#" @onclick="PreviousPage">Anterior</a>
                    </li>

                    <li class="page-item @(!_products.HasNextPage ? "disabled" : "")">
                        <a class="page-link" href="#" @onclick="NextPage">Siguiente</a>
                    </li>

                    <li class="page-item @(!_products.HasNextPage ? "disabled" : "")">
                        <a class="page-link" href="#" @onclick="() => GoToPage(_products.TotalPage)" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <p class="text-center">Página @_products.PageNumber de @_products.TotalPage</p>
        </div>
    </div>
</div>

@code {
    private PaginatedResultModel<ProductListModel> _products;
    private int _pageNumber = 1;
    private int _pageSize = 20;
    private string? _searchTerm;
    private Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        _products = await ProductService.GetAllProductsAsync(_pageNumber, _pageSize, _searchTerm);
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        _searchTerm = e.Value?.ToString();

        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(async _ =>
        {
            _pageNumber = 1;
            await InvokeAsync(async () =>
            {
                await LoadProducts();
                StateHasChanged();
            });
        }, null, 500, Timeout.Infinite);
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }

    private async Task GoToPage(int page)
    {
        _pageNumber = page;
        await LoadProducts();
    }

    private async Task PreviousPage()
    {
        _pageNumber--;
        await LoadProducts();
    }

    private async Task NextPage()
    {
        _pageNumber++;
        await LoadProducts();
    }
    private async Task OnPageSizeChanged(ChangeEventArgs e)
    {
        _pageSize = int.Parse(e.Value?.ToString() ?? "20");
        _pageNumber = 1;
        await LoadProducts();
    }
 
    private async Task OnProductCreated()
    {
        _pageNumber = 1;
        await LoadProducts();
    }
}